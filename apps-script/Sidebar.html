<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- Using Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #markup-container { transition: all 0.3s ease-in-out; }
  </style>
</head>
<body class="p-4 bg-gray-100">

  <div class="w-full">
    <h1 class="text-xl font-bold text-gray-900 mb-4">Diagram Generator</h1>

    <div class="mb-4">
      <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Describe your architecture:</label>
      <textarea id="prompt" rows="5" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y" placeholder="e.g., A mobile app sends data to a Cloud Function..."></textarea>
    </div>

    <div class="mb-4">
      <label for="model-select" class="block text-sm font-medium text-gray-700 mb-2">Enter Model Name:</label>
      <input type="text" id="model-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., gemini-2.5-flash">
    </div>

    <div class="mb-4 flex items-center">
      <input id="show-markup" type="checkbox" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
      <label for="show-markup" class="ml-2 text-sm font-medium text-gray-900">Show Mermaid Markup (Edit before render)</label>
    </div>

    <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 ease-in-out flex items-center justify-center">
      <span id="gen-btn-text">Generate</span>
      <div id="gen-loader" class="hidden loader ml-3" style="width: 20px; height: 20px; border-width: 3px;"></div>
    </button>

    <div id="markup-container" class="mt-6 border-t pt-6 border-gray-300">
       <label for="mermaid-markup" class="block text-sm font-medium text-gray-700 mb-2">Mermaid Markup:</label>
       <textarea id="mermaid-markup" rows="6" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs resize-y" spellcheck="false"></textarea>
       
       <button id="render-btn" class="mt-3 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-150 ease-in-out flex items-center justify-center">
         <span id="ren-btn-text">Render Slide</span>
         <div id="ren-loader" class="hidden loader ml-3" style="width: 20px; height: 20px; border-width: 3px; border-top-color: #4f46e5;"></div>
       </button>
    </div>

    <div id="message-box" class="hidden mt-4 p-3 rounded-lg text-sm">
      <p><strong id="message-title"></strong> <span id="message-text"></span></p>
    </div>
  </div>

  <div id="version-info" class="text-xs text-gray-500 mt-4 text-center"></div>

  <script>
    // --- Global state and element references ---
    let selectedModelId = '';
    const promptInput = document.getElementById('prompt');
    const showMarkupCb = document.getElementById('show-markup');
    const generateBtn = document.getElementById('generate-btn');
    const genBtnText = document.getElementById('gen-btn-text');
    const genLoader = document.getElementById('gen-loader');
    const markupContainer = document.getElementById('markup-container');
    const markupInput = document.getElementById('mermaid-markup');
    const renderBtn = document.getElementById('render-btn');
    const renBtnText = document.getElementById('ren-btn-text');
    const renLoader = document.getElementById('ren-loader');
    const messageBox = document.getElementById('message-box');
    const messageTitle = document.getElementById('message-title');
    const messageText = document.getElementById('message-text');

    // --- Utility Functions ---
    function setLoading(isLoading, type) {
        if (type === 'gen') {
            generateBtn.disabled = isLoading;
            genBtnText.classList.toggle('hidden', isLoading);
            genLoader.classList.toggle('hidden', !isLoading);
        } else if (type === 'ren') {
            renderBtn.disabled = isLoading;
            renBtnText.classList.toggle('hidden', isLoading);
            renLoader.classList.toggle('hidden', !isLoading);
        }
    }

    function showMessage(title, text, isError) {
        messageBox.classList.remove('hidden');
        messageBox.classList.remove('bg-green-100', 'bg-red-100');
        messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100');
        messageTitle.textContent = title + ': ';
        messageText.textContent = text;
    }

    function hideMessage() {
        messageBox.classList.add('hidden');
    }

    // --- Event Handlers ---
    window.addEventListener('load', () => {
        google.script.run.withSuccessHandler(v => {
            document.getElementById('version-info').textContent = `Version: ${v}`;
        }).withFailureHandler(onFailure).getScriptVersion();

        // Load user config
        google.script.run.withSuccessHandler(config => {
            // Set default if no config saved
            selectedModelId = config.modelId || 'gemini-2.5-flash'; 
            document.getElementById('model-select').value = selectedModelId;
        }).loadConfig();
    });

    document.getElementById('model-select').addEventListener('input', (e) => {
        selectedModelId = e.target.value;
        google.script.run.saveConfig({ modelId: selectedModelId });
    });

    showMarkupCb.addEventListener('change', () => markupContainer.classList.toggle('hidden', !showMarkupCb.checked));

    generateBtn.addEventListener('click', () => {
      if (!promptInput.value.trim()) return showMessage('Error', 'Please enter a prompt.', true);
      setLoading(true, 'gen'); hideMessage();
      google.script.run.withSuccessHandler(onGenerateSuccess).withFailureHandler(onFailure)
        .generateDiagram(promptInput.value.trim(), selectedModelId, showMarkupCb.checked);
    });

    renderBtn.addEventListener('click', () => {
        if (!markupInput.value.trim()) return showMessage('Error', 'Please enter Mermaid markup.', true);
        setLoading(true, 'ren'); hideMessage();
        google.script.run.withSuccessHandler(onRenderSuccess).withFailureHandler(onFailure)
          .renderMermaid(markupInput.value.trim());
    });

    // --- Callback Functions ---

    function onGenerateSuccess(result) {
      setLoading(false, 'gen');
      if (!result || !result.success) return showMessage('Error', result ? result.message : 'Unknown error.', true);
      if (result.mermaidCode) {
          markupInput.value = result.mermaidCode;
          // Ensure container is visible if markup is returned
          if (showMarkupCb.checked === false) { 
            showMarkupCb.checked = true; 
            markupContainer.classList.remove('hidden'); 
          }
          showMessage('Ready', 'Markup generated. Edit and click "Render Slide".', false);
      } else {
          showMessage('Success', result.message, false);
      }
    }

    function onRenderSuccess(result) {
        setLoading(false, 'ren');
        // NOTE: Actual image insertion into the document would happen here in a full implementation,
        // likely using another google.script.run call to a server-side function that
        // uses the Slides/Docs API.
        showMessage(result.success ? 'Success' : 'Render Failed', result.message, !result.success);
    }

    function onFailure(err) {
      setLoading(false, 'gen'); 
      setLoading(false, 'ren');
      showMessage('Script Error', `An AppScript error occurred: ${err.message || 'Unknown error'}`, true);
    }
  </script>
</body>
</html>
